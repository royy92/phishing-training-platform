{% extends 'training/base.html' %}
{% load i18n %}

{% block content %}
  <h2 class="mb-3">{% trans "Reports" %}</h2>

  <!-- KPIs -->
  <div class="row g-3">
    <div class="col-6 col-md-3">
      <div class="card text-bg-dark">
        <div class="card-body">
          <div class="small text-secondary">{% trans "Total attempts" %}</div>
          <div class="fs-4 fw-bold">{{ mine.total|default:0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-bg-dark">
        <div class="card-body">
          <div class="small text-secondary">{% trans "Wrong clicks" %}</div>
          <div class="fs-4 fw-bold">{{ mine.clicks|default:0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card text-bg-dark">
        <div class="card-body">
          <div class="small text-secondary">{% trans "Correct reports" %}</div>
          <div class="fs-4 fw-bold">{{ mine.reports|default:0 }}</div>
        </div>
      </div>
    </div>
    <!-- Accuracy (آمن وبسيط) -->
    <div class="col-6 col-md-3">
      <div class="card text-bg-dark">
        <div class="card-body">
          <div class="small text-secondary">{% trans "Accuracy" %}</div>
          {% with total=mine.total|default_if_none:0|default:0 correct=mine.reports|default_if_none:0|default:0 %}
            <div class="fs-4 fw-bold">
              {% if total|add:0 > 0 %}
                {% widthratio correct total 100 %}%
              {% else %}
                0%
              {% endif %}
            </div>
          {% endwith %}
        </div>
      </div>
    </div>
  </div>

  <h5 class="mt-4">{% trans "Your performance" %}</h5>
  <ul>
    <li>{% trans "Total attempts" %}: {{ mine.total|default:0 }}</li>
    <li>{% trans "Wrong clicks" %}: {{ mine.clicks|default:0 }}</li>
    <li>{% trans "Correct reports" %}: {{ mine.reports|default:0 }}</li>
  </ul>

  <!-- Charts -->
  <div class="row mt-4 g-4">
    <div class="col-12 col-lg-8">
      <div class="card text-bg-dark">
        <div class="card-body">
          <h5 class="card-title mb-3">{% trans "By scenario (bar chart)" %}</h5>
          <canvas id="byScenarioChart" height="150"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card text-bg-dark">
        <div class="card-body">
          <h5 class="card-title mb-3">{% trans "Answer distribution" %}</h5>
          <canvas id="distributionChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <h5 class="mt-4 d-flex align-items-center justify-content-between">
    <span>{% trans "By scenario" %}</span>
    <button id="exportCsvBtn" class="btn btn-outline-light btn-sm">
      {% trans "Export CSV" %}
    </button>
  </h5>

  <table id="scenarioTable" class="table table-dark table-striped">
    <thead>
      <tr>
        <th>{% trans "Scenario" %}</th>
        <th>{% trans "Total" %}</th>
        <th>{% trans "Clicks" %}</th>
        <th>{% trans "Reports" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for r in per_scenario %}
        <tr>
          <td>{{ r.scenario__title }}</td>
          <td>{{ r.total }}</td>
          <td>{{ r.clicks|default:0 }}</td>
          <td>{{ r.reports|default:0 }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4">{% trans "No data yet." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
{% endblock %}

{% block extra_js %}
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script>
    // ==== Data from context ====
    const labels  = [{% for r in per_scenario %}"{{ r.scenario__title|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const totals  = [{% for r in per_scenario %}{{ r.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const clicks  = [{% for r in per_scenario %}{{ r.clicks|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const reports = [{% for r in per_scenario %}{{ r.reports|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

    const totalAttempts = {{ mine.total|default:0 }};
    const totalCorrect  = {{ mine.reports|default:0 }};
    const totalWrong    = Math.max(0, totalAttempts - totalCorrect + {{ mine.clicks|default:0 }});

    // ==== Bar chart ====
    new Chart(document.getElementById('byScenarioChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: "{% trans 'Total' %}",   data: totals },
          { label: "{% trans 'Clicks' %}",  data: clicks },
          { label: "{% trans 'Reports' %}", data: reports }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } }
      }
    });

    // ==== Doughnut chart ====
    new Chart(document.getElementById('distributionChart').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ["{% trans 'Correct' %}", "{% trans 'Wrong' %}"],
        datasets: [{ data: [totalCorrect, totalWrong] }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    // ==== Export CSV from table ====
    document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
      const table = document.getElementById('scenarioTable');
      const rows = [...table.querySelectorAll('tr')].map(tr =>
        [...tr.querySelectorAll('th,td')].map(td => '"' + td.innerText.replace(/"/g,'""') + '"').join(',')
      ).join('\n');
      const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'report-{{ request.LANGUAGE_CODE|default:"en" }}.csv';
      a.click();
    });
  </script>
{% endblock %}
